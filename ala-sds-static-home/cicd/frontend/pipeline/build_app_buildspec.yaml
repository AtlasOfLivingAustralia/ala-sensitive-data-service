version: 0.2
###
# build the app
env:
  shell: bash
  secrets-manager:
    GOOGLE_API_KEY: ala-secrets-production:google-api-key

phases:
  install:
    on-failure: ABORT
    runtime-versions:
      nodejs: $NODE_VERSION
    commands:
      - echo installing node http-server
      - npm install http-server -g
      - echo installing yarn...
      - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
      - echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
      - apt-get update && apt-get install -y yarn lsof
      - yarn --version
  pre_build:
    commands:
      # cd to the source directory for the app
      - cd $CODEBUILD_SRC_DIR_AtlasIndexAppSourceArtifact/regions-ui
      - echo running yarn...
      - yarn install
      # - yarn playwright install --with-deps
      # - echo running tests...
      # - yarn test
      # - echo VITE_GOOGLE_MAP_API_KEY=$GOOGLE_API_KEY >> ./config/.env.playwright
      # - ./run-playwright-test.sh 1
  build:
    commands:
      - echo building...
      # - echo VITE_GOOGLE_MAP_API_KEY=$GOOGLE_API_KEY >> ./config/.env.$ENVIRONMENT
      - yarn run build:$ENVIRONMENT
      - echo deploying...
      - aws s3 sync dist/assets s3://$SOURCE_BUCKET/$REGIONS_BUCKET_PATH/assets --delete --cache-control "max-age=86400,public"
      - aws s3 cp dist/index.html s3://$SOURCE_BUCKET/$REGIONS_BUCKET_PATH/index.html --cache-control "no-cache, max-age=0, must-revalidate"

artifacts:
  base-directory: $CODEBUILD_SRC_DIR_AtlasIndexAppSourceArtifact/regions-ui/dist
  files:
    - '**/*'